#!/usr/bin/python

from KickassAPI import *
import gzip, urllib2, sys
from StringIO import *

torrentList = \
"uptown funk\nrolling stones she's so cold\nthis is how we do\n\
time of your life\nsavage garden to the moon and back\nall of me john legend"

def getQueries():
  #q = torrentList
  q = raw_input("Enter Qurey: ")
  return q
  
def main():
  #try:
    queries = getQueries()
    v = 1
    for q in queries.split('\n'):
      print "searching:\n", q
      result = None
      try:
	result = Search(q)
      except ValueError:
	print "no matches found for:\n", q
	continue
      resList = result.list()
      res_count = min(3, len(resList))
      if res_count:
	first = resList[0]
	name = first.name+".torrent"
	url  = first.download_link
	print "downloading: ", name
	output = open(name, 'wb')
	req = urllib2.Request(url)
	opener = urllib2.build_opener()
	response = opener.open(req)
	data = response.read()
	if response.info()['content-encoding'] == 'gzip':
	    sio = StringIO(data)
	    gzipper = gzip.GzipFile(fileobj=sio)
	    plain = gzipper.read()
	    data = plain
	output.write(data)
	output.close()
  #except:
   # print "Unexpected error:", sys.exc_info()[0]
    #raise  

main()